pipeline {
  agent { label 'linux_64' }
  parameters {
    booleanParam (
      defaultValue: false,
      description: 'Wipe out current workspace',
      name: 'wipe'
    )
    choice (
      choices: [
        'print_branches',
        'start_release',
        'merge_release',
        'finish_release',
        'unprotect_release'
      ],
      description: 'Action type',
      name: 'action_type'
    )
    choice (
      choices: ['hotfix', 'release'],
      description: 'Release type',
      name: 'release_type'
    )
    string (
      defaultValue: 'v0.0.0',
      description: 'Release version',
      name: 'release_vesion'
    )
    booleanParam (
      defaultValue: true,
      description: 'Protect branch (for start_release only)',
      name: 'protect_branch'
    )
    string (
      defaultValue: '',
      description: 'Extra branch (for hotfix finish_release only)',
      name: 'extra_branch'
    )
  }
  stages {
    stage('Prepare') {
      steps {
        script {
          if (params.wipe) {
            deleteDir()
            checkout scm
          }
          branch = params.release_type + '/' + params.release_vesion
        }
      }
    }
    stage('Flow') {
      parallel {
        stage('Print Branches') {
          when {
            expression { params.action_type == 'print_branches' }
            beforeAgent true
          }
          steps {
            script {
              def utils = load "utils.groovy"
              utils.printReposBranches()
            }
          }
        }
        stage('Unprotect Release') {
          when {
            expression { params.action_type == 'unprotect_release' }
            beforeAgent true
          }
          steps {
            script {
              def utils = load "utils.groovy"
              utils.unprotectRelease(branch)
            }
          }
        }
        stage('Start Release') {
          when {
            expression { params.action_type == 'start_release' }
            beforeAgent true
          }
          steps {
            script {
              def utils = load "utils.groovy"
              utils.checkoutRepos('master')
              String baseBranch
              if (params.release_type == 'hotfix') {
                baseBranch = 'master'
              } else if (params.release_type == 'release') {
                baseBranch = 'develop'
              }
              utils.startRelease(branch, baseBranch, params.protect_branch)
            }
          }
        }
        stage('Merge Release') {
          when {
            expression { params.action_type == 'merge_release' }
            beforeAgent true
          }
          steps {
            script {
              def utils = load "utils.groovy"
              utils.checkoutRepos('master')
              utils.mergeRelease(branch)
            }
          }
        }
        stage('Finish Release') {
          when {
            expression { params.action_type == 'finish_release' }
            beforeAgent true
          }
          steps {
            script {
              def utils = load "utils.groovy"
              utils.checkoutRepos('master')
              if (!params.extra_branch.isEmpty() && params.release_type == 'hotfix') {
                utils.finishRelease(branch, params.extra_branch)
              } else {
                utils.finishRelease(branch)
              }
            }
          }
        }
      }
    }
  }
}
